<style>
    .info-text, .error-text {
        text-align: center;
        color: #888;
        padding: 20px;
        margin: 0;
    }

    .conversation-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .conversation-item:hover {
        background: #f5f5f5;
    }

    .conversation-item.active {
        background-color: #e6f7ff;
    }

    .conversation-item.unread {
        font-weight: bold;
    }

    .conversation-item.pinned {
        background: #fffbe6;
    }

    .pin-icon {
        margin-right: 8px;
        color: #ffcc00;
    }

    .unread-dot {
        width: 8px;
        height: 8px;
        background-color: #ff3b30;
        border-radius: 50%;
        margin-left: 10px;
    }

    #conversation-list {
        max-height: calc(100vh - 160px);
        overflow-y: auto;
        padding-bottom: 10px;
    }
</style>

<script>
    loadConversations();

    function requestNotificationPermission() {
        if ("Notification" in window) {
            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        console.log("Permission de notification accordée.");
                    } else {
                        console.warn("Permission de notification refusée ou ignorée.");
                    }
                });
            }
        }
    }

    async function showNewMessageNotification(chatId, messageText, partnerId) {
        if (Notification.permission === "granted" && chatId !== currentChatId) {
            let partnerName = usernameCache[partnerId];
            if (!partnerName) {
                const partnerDoc = await db.collection("users").doc(partnerId).get();
                partnerName = partnerDoc.exists ? partnerDoc.data().username || partnerDoc.data().email.split('@')[0] : "Quelqu'un";
                usernameCache[partnerId] = partnerName;
            }

            new Notification(`Nouveau message de ${partnerName}`, {
                body: messageText,
                icon: 'https://via.placeholder.com/64/4A90E2/FFFFFF?text=ON',
                tag: chatId,
                renotify: true
            });
        }
    }

    async function loadConversations() {
        if (!currentUser) {
            conversationListDiv.innerHTML = '<p class="info-text">Veuillez vous connecter pour voir vos conversations.</p>';
            return;
        }
        if (!currentUserData) {
            conversationListDiv.innerHTML = '<p class="info-text">Chargement de votre profil...</p>';
            return;
        }

        conversationListDiv.innerHTML = '<p class="info-text">Chargement des conversations...</p>';

        try {
            const userChatsSnapshot = await db.collection("chats")
                .where("participants", "array-contains", currentUser.uid)
                .orderBy("updatedAt", "desc")
                .get();

            const conversations = [];
            const partnerIdsToFetch = new Set();

            userChatsSnapshot.forEach(doc => {
                const chatData = doc.data();
                const chatId = doc.id;
                const partnerId = chatData.participants.find(p => p !== currentUser.uid);
                if (partnerId) {
                    partnerIdsToFetch.add(partnerId);
                    conversations.push({
                        chatId,
                        partnerId,
                        lastMessageTimestamp: chatData.updatedAt ? chatData.updatedAt.toDate() : new Date(0),
                        isPinned: currentUserData.pinnedChats?.includes(chatId),
                        isUnread: unreadMessagesTracker[chatId] || false
                    });
                }
            });

            await Promise.all(Array.from(partnerIdsToFetch).map(async (pId) => {
                if (!usernameCache[pId]) {
                    const partnerDoc = await db.collection("users").doc(pId).get();
                    usernameCache[pId] = partnerDoc.exists ? partnerDoc.data().username || partnerDoc.data().email.split('@')[0] : "Utilisateur Inconnu";
                }
            }));

            conversations.sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                return b.lastMessageTimestamp - a.lastMessageTimestamp;
            });

            conversationListDiv.innerHTML = '';
            if (conversations.length === 0) {
                conversationListDiv.innerHTML = '<p class="info-text">Aucune conversation pour le moment.<br>Cliquez sur <i class="fas fa-plus-circle"></i> pour en démarrer une.</p>';
                return;
            }

            conversations.forEach(conv => {
                const partnerName = usernameCache[conv.partnerId];
                const itemHtml = `
                    <div class="conversation-item ${conv.chatId === currentChatId ? 'active' : ''} ${conv.isUnread ? 'unread' : ''} ${conv.isPinned ? 'pinned' : ''}" data-chat-id="${conv.chatId}" data-partner-id="${conv.partnerId}">
                        <span class="pin-icon"><i class="fas fa-star"></i></span>
                        <span>${partnerName}</span>
                        <span class="unread-dot"></span>
                    </div>
                `;
                conversationListDiv.insertAdjacentHTML('beforeend', itemHtml);
            });

            attachConversationClickListeners();

        } catch (error) {
            console.error("Erreur de chargement des conversations:", error);
            conversationListDiv.innerHTML = '<p class="error-text">Erreur de chargement des conversations.</p>';
        }
    }

    function attachConversationClickListeners() {
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.onclick = () => selectConversation(item.dataset.chatId, item.dataset.partnerId);
        });
    }
</script>
